{% extends "base.html" %}

{% block title %}AI ì§„ì‹¤ì„± íƒì§€ê¸° - í™ˆ{% endblock %}
<!-- Updated: 2025-01-09 -->

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary mb-3">
                <i class="fas fa-shield-alt me-3"></i>
                AI ì§„ì‹¤ì„± íƒì§€ê¸°
            </h1>
            <p class="lead text-muted">
                AIê°€ ê±°ì§“ë§ì„ í•˜ëŠ”ì§€ ì¸¡ì •í•˜ê³ , 1% ì´ìƒ ê±°ì§“ë§ì„ ê°ì§€í•˜ë©´ ìë™ìœ¼ë¡œ êµì •í•©ë‹ˆë‹¤
            </p>
        </div>
    </div>
</div>

<!-- ê¸°ëŠ¥ ì„ íƒ ì„¹ì…˜ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>ë¶„ì„ ëª¨ë“œ ì„ íƒ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary w-100 analysis-mode-btn active" data-mode="all">
                            <i class="fas fa-layer-group me-2"></i>í†µí•© ë¶„ì„
                            <small class="d-block">ëª¨ë“  ê¸°ëŠ¥ ì‚¬ìš©</small>
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-success w-100 analysis-mode-btn" data-mode="puns">
                            <i class="fas fa-smile me-2"></i>ë§ì¥ë‚œ ë¶„ì„
                            <small class="d-block">ì–¸ì–´ì  ìœ ë¨¸ ê°ì§€</small>
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-warning w-100 analysis-mode-btn" data-mode="coding">
                            <i class="fas fa-code me-2"></i>ì½”ë”© í’ˆì§ˆ
                            <small class="d-block">ì½”ë“œ í’ˆì§ˆ ê²€ì¦</small>
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-info w-100 analysis-mode-btn" data-mode="multilingual">
                            <i class="fas fa-globe me-2"></i>ë‹¤êµ­ì–´ ë¶„ì„
                            <small class="d-block">ì–¸ì–´ í˜¼í•© ê°ì§€</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ë¶„ì„ ì…ë ¥ ì„¹ì…˜ -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>
                    AI ë¬¸ì¥ ë¶„ì„
                </h5>
            </div>
            <div class="card-body">
                <form id="analysisForm">
                    <div class="mb-3">
                        <label for="statement" class="form-label">ë¶„ì„í•  ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”:</label>
                        <textarea 
                            class="form-control" 
                            id="statement" 
                            name="statement" 
                            rows="4" 
                            placeholder="ì˜ˆ: ì§€êµ¬ëŠ” ì™„ì „íˆ ë‘¥ê¸€ê³  ëª¨ë“  ì‚¬ëŒì´ ì´ë¥¼ ì•Œê³  ìˆë‹¤."
                            required
                        ></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="context" class="form-label">ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸ (ì„ íƒì‚¬í•­):</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="context" 
                            name="context" 
                            placeholder="ì˜ˆ: ê³¼í•™ì  ì‚¬ì‹¤ì— ëŒ€í•œ ì„¤ëª…"
                        >
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-play me-2"></i>
                        ì§„ì‹¤ì„± ë¶„ì„ ì‹œì‘
                    </button>
                </form>
                
                <!-- ë¡œë”© í‘œì‹œ -->
                <div class="loading text-center mt-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">ë¶„ì„ ì¤‘...</span>
                    </div>
                    <p class="mt-2 text-muted">AIì˜ ì§„ì‹¤ì„±ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    ë¶„ì„ ê²°ê³¼
                </h5>
            </div>
            <div class="card-body" id="analysisResult">
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <p>ë¶„ì„í•  ë¬¸ì¥ì„ ì…ë ¥í•˜ê³  "ì§„ì‹¤ì„± ë¶„ì„ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìµœê·¼ ë¶„ì„ ê²°ê³¼ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    ìµœê·¼ ë¶„ì„ ê²°ê³¼
                </h5>
            </div>
            <div class="card-body">
                <div id="recentAnalyses">
                    <div class="text-center text-muted">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p>ì•„ì§ ë¶„ì„ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('analysisForm');
    const loading = document.querySelector('.loading');
    const resultDiv = document.getElementById('analysisResult');
    const recentDiv = document.getElementById('recentAnalyses');
    
    // ë¶„ì„ ëª¨ë“œ ë³€ìˆ˜
    let currentAnalysisMode = 'all'; // ê¸°ë³¸ê°’: í†µí•© ë¶„ì„
    
    // ë¶„ì„ ëª¨ë“œ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.querySelectorAll('.analysis-mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.analysis-mode-btn').forEach(b => b.classList.remove('active'));
            
            // í´ë¦­ëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
            this.classList.add('active');
            
            // ë¶„ì„ ëª¨ë“œ ì—…ë°ì´íŠ¸
            currentAnalysisMode = this.dataset.mode;
            
            // ëª¨ë“œì— ë”°ë¥¸ ì„¤ëª… ì—…ë°ì´íŠ¸
            updateModeDescription();
        });
    });
    
    // ëª¨ë“œ ì„¤ëª… ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateModeDescription() {
        const descriptions = {
            'all': 'ëª¨ë“  ë¶„ì„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ì¢…í•©ì ìœ¼ë¡œ ë¬¸ì¥ì„ ë¶„ì„í•©ë‹ˆë‹¤.',
            'puns': 'ì–¸ì–´ì  ìœ ë¨¸ì™€ ë§ì¥ë‚œì„ ê°ì§€í•˜ê³  ì´í•´í•©ë‹ˆë‹¤.',
            'coding': 'ì½”ë”© í’ˆì§ˆê³¼ ì˜ë„ì  ì¡°ì‘ì„ ë¶„ì„í•©ë‹ˆë‹¤.',
            'multilingual': 'ë‹¤êµ­ì–´ ë¬¸ì¥ì„ ë¶„ì„í•˜ê³  ì–¸ì–´ë³„ ì˜ë¯¸ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤.'
        };
        
        const descriptionElement = document.querySelector('.lead.text-muted');
        if (descriptionElement) {
            descriptionElement.textContent = descriptions[currentAnalysisMode];
        }
    }
    
    // í¼ ì œì¶œ ì²˜ë¦¬
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const statement = document.getElementById('statement').value.trim();
        const context = document.getElementById('context').value.trim();
        
        if (!statement) {
            alert('ë¶„ì„í•  ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ë¡œë”© í‘œì‹œ
        loading.classList.add('show');
        resultDiv.innerHTML = '';
        
        try {
            // ì„ íƒëœ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ API ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
            const endpoint = currentAnalysisMode === 'all' ? '/analyze' : `/analyze/${currentAnalysisMode}`;
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    statement: statement,
                    context: context
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                displayAnalysisResult(data.analysis);
                loadRecentAnalyses();
            } else {
                throw new Error(data.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${error.message}
                </div>
            `;
        } finally {
            loading.classList.remove('show');
        }
    });
    
    // í†µí•© ë¶„ì„ ê²°ê³¼ í‘œì‹œ
    function displayAnalysisResult(analysis) {
        const finalAnalysis = analysis.final_analysis;
        const truthPercentage = (finalAnalysis.truth_percentage * 100).toFixed(1);
        const confidence = (finalAnalysis.confidence * 100).toFixed(1);
        
        let resultHtml = `
            <div class="mb-3">
                <h6>í†µí•© ì§„ì‹¤ì„± ì ìˆ˜</h6>
                <div class="truth-meter mb-2">
                    <div class="truth-indicator" style="width: ${truthPercentage}%"></div>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="badge bg-${truthPercentage >= 99 ? 'success' : truthPercentage >= 70 ? 'warning' : 'danger'} fs-6">
                        ${truthPercentage}%
                    </span>
                    <small class="text-muted">ì‹ ë¢°ë„: ${confidence}%</small>
                </div>
            </div>
        `;
        
        // íƒì§€ê¸°ë³„ ê²°ê³¼ í‘œì‹œ
        resultHtml += `
            <div class="mb-3">
                <h6>íƒì§€ê¸°ë³„ ë¶„ì„ ê²°ê³¼</h6>
                <div class="row g-2">
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.meta_analysis.meta_lie_detected ? 'danger' : 'success'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ë©”íƒ€-ì§„ì‹¤ì„±</small>
                                <div class="text-${analysis.meta_analysis.meta_lie_detected ? 'danger' : 'success'}">
                                    <i class="fas fa-${analysis.meta_analysis.meta_lie_detected ? 'times' : 'check'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.religious_analysis.religious_topic_detected ? 'warning' : 'secondary'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ì¢…êµì  ë§¥ë½</small>
                                <div class="text-${analysis.religious_analysis.religious_topic_detected ? 'warning' : 'secondary'}">
                                    <i class="fas fa-${analysis.religious_analysis.religious_topic_detected ? 'exclamation-triangle' : 'minus'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.scientific_analysis.scientific_lie_detected ? 'danger' : 'success'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ê³¼í•™ì  ê²€ì¦</small>
                                <div class="text-${analysis.scientific_analysis.scientific_lie_detected ? 'danger' : 'success'}">
                                    <i class="fas fa-${analysis.scientific_analysis.scientific_lie_detected ? 'times' : 'check'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.intentional_analysis.intentional_lie_detected ? 'warning' : 'secondary'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ì˜ë„ì  ê±°ì§“ë§</small>
                                <div class="text-${analysis.intentional_analysis.intentional_lie_detected ? 'warning' : 'secondary'}">
                                    <i class="fas fa-${analysis.intentional_analysis.intentional_lie_detected ? 'exclamation-triangle' : 'minus'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.human_behavior_analysis.is_human_behavior_lie ? 'danger' : 'success'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ì¸ê°„ í–‰ë™</small>
                                <div class="text-${analysis.human_behavior_analysis.is_human_behavior_lie ? 'danger' : 'success'}">
                                    <i class="fas fa-${analysis.human_behavior_analysis.is_human_behavior_lie ? 'times' : 'check'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.benevolent_analysis.is_benevolent_lie ? 'info' : 'secondary'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ì„ ì˜ì˜ ê±°ì§“ë§</small>
                                <div class="text-${analysis.benevolent_analysis.is_benevolent_lie ? 'info' : 'secondary'}">
                                    <i class="fas fa-${analysis.benevolent_analysis.is_benevolent_lie ? 'heart' : 'minus'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.context_analysis.context_correction_applied ? 'primary' : 'secondary'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ë§¥ë½ ì¸ì‹</small>
                                <div class="text-${analysis.context_analysis.context_correction_applied ? 'primary' : 'secondary'}">
                                    <i class="fas fa-${analysis.context_analysis.context_correction_applied ? 'language' : 'minus'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.compound_analysis.compound_correction_applied ? 'dark' : 'secondary'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ë³µí•© ë¬¸ì¥</small>
                                <div class="text-${analysis.compound_analysis.compound_correction_applied ? 'dark' : 'secondary'}">
                                    <i class="fas fa-${analysis.compound_analysis.compound_correction_applied ? 'layer-group' : 'minus'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.puns_analysis.is_pun_detected ? 'success' : 'secondary'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ë§ì¥ë‚œ</small>
                                <div class="text-${analysis.puns_analysis.is_pun_detected ? 'success' : 'secondary'}">
                                    <i class="fas fa-${analysis.puns_analysis.is_pun_detected ? 'smile' : 'minus'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.coding_analysis.unnecessary_code_detected ? 'warning' : 'secondary'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ì½”ë”© í’ˆì§ˆ</small>
                                <div class="text-${analysis.coding_analysis.unnecessary_code_detected ? 'warning' : 'secondary'}">
                                    <i class="fas fa-${analysis.coding_analysis.unnecessary_code_detected ? 'code' : 'minus'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card detector-card border-${analysis.multilingual_analysis.is_multilingual ? 'info' : 'secondary'}">
                            <div class="card-body p-2">
                                <small class="fw-bold">ë‹¤êµ­ì–´</small>
                                <div class="text-${analysis.multilingual_analysis.is_multilingual ? 'info' : 'secondary'}">
                                    <i class="fas fa-${analysis.multilingual_analysis.is_multilingual ? 'globe' : 'minus'}"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ë§ì¥ë‚œ ê°ì§€ ì‹œ íŠ¹ë³„ í‘œì‹œ
        if (analysis.puns_analysis && analysis.puns_analysis.is_pun_detected) {
            resultHtml += `
                <div class="alert alert-success">
                    <i class="fas fa-smile me-2"></i>
                    <strong>ë§ì¥ë‚œ ê°ì§€!</strong> AIê°€ ì–¸ì–´ì  ìœ ë¨¸ë¥¼ ì´í•´í–ˆìŠµë‹ˆë‹¤! ğŸ˜„
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-lightbulb text-warning me-2"></i>ë§ì¥ë‚œ ë¶„ì„ ê²°ê³¼</h6>
                    <div class="alert alert-info">
                        <strong>ì´í•´ë„:</strong> ${(analysis.puns_analysis.pun_understanding * 100).toFixed(1)}%<br>
                        <strong>ê°ì§€ëœ ìœ í˜•:</strong> ${analysis.puns_analysis.pun_types.join(', ')}<br>
                        <strong>AI ì‘ë‹µ:</strong><br>
                        <em>${analysis.puns_analysis.pun_response.replace(/\n/g, '<br>')}</em>
                    </div>
                </div>
            `;
        } else if (analysis.multilingual_analysis && analysis.multilingual_analysis.is_multilingual) {
            resultHtml += `
                <div class="alert alert-info">
                    <i class="fas fa-globe me-2"></i>
                    <strong>ë‹¤êµ­ì–´ ë¬¸ì¥ ê°ì§€!</strong> ì—¬ëŸ¬ ì–¸ì–´ê°€ ì„ì¸ ë¬¸ì¥ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-language text-info me-2"></i>ë‹¤êµ­ì–´ ë¶„ì„ ê²°ê³¼</h6>
                    <div class="alert alert-info">
                        <strong>ê°ì§€ëœ ì–¸ì–´:</strong> ${analysis.multilingual_analysis.detected_languages.join(', ')}<br>
                        <strong>ì´í•´ë„:</strong> ${(analysis.multilingual_analysis.understanding_score * 100).toFixed(1)}%<br>
                        <strong>ì–¸ì–´ ë¶„í¬:</strong><br>
                        ${Object.entries(analysis.multilingual_analysis.language_distribution).map(([lang, data]) => 
                            `â€¢ ${data.name}: ${data.char_count}ê°œ ë¬¸ì (${data.percentage.toFixed(1)}%)`
                        ).join('<br>')}<br>
                        <strong>AI ì‘ë‹µ:</strong><br>
                        <em>${analysis.multilingual_analysis.ai_response.replace(/\n/g, '<br>')}</em>
                    </div>
                </div>
            `;
        } else if (analysis.coding_analysis && analysis.coding_analysis.is_coding_analysis) {
            resultHtml += `
                <div class="alert alert-${analysis.coding_analysis.is_intentional_manipulation ? 'danger' : 'warning'}">
                    <i class="fas fa-code me-2"></i>
                    <strong>ì½”ë”© í’ˆì§ˆ ë¶„ì„!</strong> ${analysis.coding_analysis.is_intentional_manipulation ? 'ì˜ë„ì  ì¡°ì‘ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ì½”ë”© í’ˆì§ˆì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.'}
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-chart-line text-primary me-2"></i>ì½”ë”© í’ˆì§ˆ ë¶„ì„ ê²°ê³¼</h6>
                    <div class="alert alert-${analysis.coding_analysis.is_intentional_manipulation ? 'danger' : 'info'}">
                        <strong>í’ˆì§ˆ ì ìˆ˜:</strong> ${(analysis.coding_analysis.quality_score * 100).toFixed(1)}%<br>
                        <strong>í’ˆì§ˆ ë“±ê¸‰:</strong> ${analysis.coding_analysis.quality_grade}<br>
                        <strong>ë¶ˆí•„ìš”í•œ ì½”ë“œ:</strong> ${analysis.coding_analysis.unnecessary_code_detected ? 'ê°ì§€ë¨' : 'ì—†ìŒ'}<br>
                        <strong>ì˜ë„ì  ì¡°ì‘:</strong> ${analysis.coding_analysis.is_intentional_manipulation ? 'ê°ì§€ë¨' : 'ì—†ìŒ'}<br>
                        <strong>AI ì‘ë‹µ:</strong><br>
                        <em>${analysis.coding_analysis.ai_response.replace(/\n/g, '<br>')}</em>
                    </div>
                </div>
            `;
        } else if (finalAnalysis.needs_correction) {
            resultHtml += `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>ê±°ì§“ë§ ê°ì§€!</strong> êµì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
            `;
            
            // êµì • ëŠ¥ë ¥ ê°•í™” ê²°ê³¼ í‘œì‹œ
            if (analysis.correction_enhancement.enhanced_correction_applied && analysis.correction_enhancement.corrected_statement) {
                resultHtml += `
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-tools me-2"></i>
                            <strong>êµì • ëŠ¥ë ¥ ê°•í™” ì ìš©!</strong> AIê°€ ê±°ì§“ë§ì„ ê°ì§€í•˜ê³  êµì •í–ˆìŠµë‹ˆë‹¤.
                        </div>
                        <h6>ì›ë³¸ ë¬¸ì¥:</h6>
                        <div class="bg-danger bg-opacity-10 p-3 rounded mb-2">
                            <em class="text-danger">${analysis.statement}</em>
                        </div>
                        <h6>êµì •ëœ ë¬¸ì¥:</h6>
                        <div class="bg-success bg-opacity-10 p-3 rounded">
                            <em class="text-success">${analysis.correction_enhancement.corrected_statement}</em>
                        </div>
                    </div>
                `;
            }
            
            // ë§¥ë½ ì¸ì‹ ê²°ê³¼ í‘œì‹œ
            if (analysis.context_analysis && analysis.context_analysis.context_type !== 'unknown') {
                resultHtml += `
                    <div class="mb-3">
                        <h6><i class="fas fa-language text-primary me-2"></i>ë§¥ë½ ì¸ì‹ ê²°ê³¼</h6>
                        <div class="alert alert-info">
                            <strong>ë§¥ë½ ìœ í˜•:</strong> ${analysis.context_analysis.context_type}<br>
                            <strong>ì˜ë¯¸:</strong> ${analysis.context_analysis.contextual_meaning}<br>
                            ${analysis.context_analysis.context_warnings && analysis.context_analysis.context_warnings.length > 0 ? 
                                `<strong>ê²½ê³ :</strong> ${analysis.context_analysis.context_warnings[0]}` : ''}
                        </div>
                    </div>
                `;
            }
            
            // ë³µí•© ë¬¸ì¥ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            if (analysis.compound_analysis && analysis.compound_analysis.compound_type !== 'simple') {
                resultHtml += `
                    <div class="mb-3">
                        <h6><i class="fas fa-layer-group text-dark me-2"></i>ë³µí•© ë¬¸ì¥ ë¶„ì„ ê²°ê³¼</h6>
                        <div class="alert alert-secondary">
                            <strong>ë³µí•© ìœ í˜•:</strong> ${analysis.compound_analysis.compound_type}<br>
                            <strong>ë¶„ë¦¬ëœ ë¬¸ì¥ ìˆ˜:</strong> ${analysis.compound_analysis.sentence_count}ê°œ<br>
                            <strong>ë¶„ë¦¬ëœ ë¬¸ì¥ë“¤:</strong><br>
                            ${analysis.compound_analysis.sentences.map((sentence, index) => 
                                `<small class="text-muted">${index + 1}. ${sentence}</small><br>`
                            ).join('')}
                            ${analysis.compound_analysis.compound_warnings && analysis.compound_analysis.compound_warnings.length > 0 ? 
                                `<strong>ê²½ê³ :</strong> ${analysis.compound_analysis.compound_warnings[0]}` : ''}
                        </div>
                    </div>
                `;
            }
            
            // ê°ì§€ëœ ë¬¸ì œì ë“¤ í‘œì‹œ
            let allDetectedLies = [];
            if (analysis.basic_analysis.detected_lies) allDetectedLies = allDetectedLies.concat(analysis.basic_analysis.detected_lies);
            if (analysis.meta_analysis.meta_lies) allDetectedLies = allDetectedLies.concat(analysis.meta_analysis.meta_lies);
            if (analysis.scientific_analysis.detected_scientific_lies) allDetectedLies = allDetectedLies.concat(analysis.scientific_analysis.detected_scientific_lies);
            if (analysis.human_behavior_analysis.detected_human_behavior_lies) allDetectedLies = allDetectedLies.concat(analysis.human_behavior_analysis.detected_human_behavior_lies);
            
            if (allDetectedLies.length > 0) {
                resultHtml += `
                    <div class="mb-3">
                        <h6>ê°ì§€ëœ ë¬¸ì œì :</h6>
                        <ul class="list-unstyled">
                            ${allDetectedLies.map(lie => `<li><i class="fas fa-times text-danger me-2"></i>${lie}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // êµì • ì œì•ˆ í‘œì‹œ
            if (analysis.basic_analysis.correction_suggestions && analysis.basic_analysis.correction_suggestions.length > 0) {
                resultHtml += `
                    <div class="mb-3">
                        <h6>êµì • ì œì•ˆ:</h6>
                        <ul class="list-unstyled">
                            ${analysis.basic_analysis.correction_suggestions.map(suggestion => `<li><i class="fas fa-lightbulb text-warning me-2"></i>${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        } else {
            resultHtml += `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>ì§„ì‹¤ì„± í™•ì¸!</strong> ì´ ë¬¸ì¥ì€ ì‹ ë¢°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            `;
        }
        
        // ì² í•™ì  ë…¸íŠ¸ í‘œì‹œ
        let philosophicalNotes = [];
        if (analysis.meta_analysis.philosophical_note) philosophicalNotes.push(analysis.meta_analysis.philosophical_note);
        if (analysis.religious_analysis.philosophical_note) philosophicalNotes.push(analysis.religious_analysis.philosophical_note);
        if (analysis.scientific_analysis.philosophical_note) philosophicalNotes.push(analysis.scientific_analysis.philosophical_note);
        if (analysis.intentional_analysis.philosophical_note) philosophicalNotes.push(analysis.intentional_analysis.philosophical_note);
        
        if (philosophicalNotes.length > 0) {
            resultHtml += `
                <div class="mb-3">
                    <h6>ì² í•™ì  ê´€ì :</h6>
                    <div class="bg-light p-3 rounded">
                        ${philosophicalNotes.map(note => `<p class="mb-1"><em>${note}</em></p>`).join('')}
                    </div>
                </div>
            `;
        }
        
        resultDiv.innerHTML = resultHtml;
    }
    
    // ìµœê·¼ ë¶„ì„ ê²°ê³¼ ë¡œë“œ
    async function loadRecentAnalyses() {
        try {
            const response = await fetch('/api/recent_analyses');
            const analyses = await response.json();
            
            if (analyses.length === 0) {
                recentDiv.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p>ì•„ì§ ë¶„ì„ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            analyses.forEach(analysis => {
                const finalAnalysis = analysis.final_analysis || analysis;
                const truthPercentage = (finalAnalysis.truth_percentage * 100).toFixed(1);
                const timestamp = new Date(analysis.timestamp).toLocaleString('ko-KR');
                
                // íƒì§€ê¸°ë³„ ì•„ì´ì½˜ ìƒì„±
                let detectorIcons = '';
                if (analysis.meta_analysis && analysis.meta_analysis.meta_lie_detected) detectorIcons += '<i class="fas fa-mirror text-danger me-1" title="ë©”íƒ€-ì§„ì‹¤ì„±"></i>';
                if (analysis.religious_analysis && analysis.religious_analysis.religious_topic_detected) detectorIcons += '<i class="fas fa-cross text-warning me-1" title="ì¢…êµì  ë§¥ë½"></i>';
                if (analysis.scientific_analysis && analysis.scientific_analysis.scientific_lie_detected) detectorIcons += '<i class="fas fa-flask text-danger me-1" title="ê³¼í•™ì  ê²€ì¦"></i>';
                if (analysis.intentional_analysis && analysis.intentional_analysis.intentional_lie_detected) detectorIcons += '<i class="fas fa-brain text-warning me-1" title="ì˜ë„ì  ê±°ì§“ë§"></i>';
                if (analysis.human_behavior_analysis && analysis.human_behavior_analysis.is_human_behavior_lie) detectorIcons += '<i class="fas fa-user-times text-danger me-1" title="ì¸ê°„ í–‰ë™"></i>';
                if (analysis.benevolent_analysis && analysis.benevolent_analysis.is_benevolent_lie) detectorIcons += '<i class="fas fa-heart text-info me-1" title="ì„ ì˜ì˜ ê±°ì§“ë§"></i>';
                if (analysis.correction_enhancement && analysis.correction_enhancement.enhanced_correction_applied) detectorIcons += '<i class="fas fa-tools text-success me-1" title="êµì • ê°•í™”"></i>';
                if (analysis.context_analysis && analysis.context_analysis.context_correction_applied) detectorIcons += '<i class="fas fa-language text-primary me-1" title="ë§¥ë½ ì¸ì‹"></i>';
                if (analysis.compound_analysis && analysis.compound_analysis.compound_correction_applied) detectorIcons += '<i class="fas fa-layer-group text-dark me-1" title="ë³µí•© ë¬¸ì¥"></i>';
                if (analysis.puns_analysis && analysis.puns_analysis.is_pun_detected) detectorIcons += '<i class="fas fa-smile text-success me-1" title="ë§ì¥ë‚œ"></i>';
                if (analysis.coding_analysis && analysis.coding_analysis.unnecessary_code_detected) detectorIcons += '<i class="fas fa-code text-warning me-1" title="ì½”ë”© í’ˆì§ˆ"></i>';
                if (analysis.multilingual_analysis && analysis.multilingual_analysis.is_multilingual) detectorIcons += '<i class="fas fa-globe text-info me-1" title="ë‹¤êµ­ì–´"></i>';
                
                html += `
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="badge bg-${truthPercentage >= 99 ? 'success' : truthPercentage >= 70 ? 'warning' : 'danger'} me-2">
                                    ${truthPercentage}%
                                </span>
                                ${detectorIcons}
                            </div>
                            <small class="text-muted">${timestamp}</small>
                        </div>
                        <p class="mb-1">${analysis.statement}</p>
                        ${finalAnalysis.needs_correction ? '<small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>êµì • í•„ìš”</small>' : '<small class="text-success"><i class="fas fa-check me-1"></i>ì§„ì‹¤ì„± í™•ì¸</small>'}
                    </div>
                `;
            });
            
            recentDiv.innerHTML = html;
        } catch (error) {
            console.error('ìµœê·¼ ë¶„ì„ ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœê·¼ ë¶„ì„ ê²°ê³¼ ë¡œë“œ
    loadRecentAnalyses();
});
</script>
{% endblock %}
